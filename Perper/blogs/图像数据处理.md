[TOC]

# 图像数据处理

## TFRecord数据格式

当我们需要处理的数据复杂，我们需要有效处理输入数据的信息。tensorflow提供了TFRecord来同意数据的存储。

### TFRecord格式介绍

TFRecord文件的数据是通过`tf.train.Example Protocol buffer`来保存的，下面是`tf.train.Example`的定义：

```python
message Example{
  Features features = 1;
};
message Features{
  map<string,Feature> feature = 1;
};
message Feature{
  oneof kind{
    ByteList bytes_lst = 1;
    FloatList float_list = 2;
    Int64List int64_list = 3;
  };
}
```

Example 是一个数据结构比较简洁的数据，属性取值包含三类，例如图像可以解码成string，类别可以解码成int。下面是使用TFRecord对数据mnist进行保存：

```python
from tensorflow.examples.tutorials.mnist import input_data
import numpy as np

def _int64_features(value):
    return tf.train.Feature(int64_list = tf.train.Int64List(value=[value]))

def _bytes_features(value):
    return tf.train.Feature(bytes_list = tf.train.BytesList(value=[value]))

mnist = input_data.read_data_sets(
    "./data",dtype=tf.uint8,one_hot=True
)
images = mnist.train.images

labels = mnist.train.labels
pixels = images.shape[1]
num_examples = mnist.train.num_examples

filename = './output.tfrecords'

writer = tf.python_io.TFRecordWriter(filename)
for index in range(num_examples):
    image_raw = images[index].tostring()
    example = tf.train.Example(features=tf.train.Features(feature={
        'pixels': _int64_features(pixel),
        'label' : _int64_features(np.argmax(labels[index])),
        'image_raw': _bytes_features(image_raw)
    }))
    writer.write(example.SerializeToString())
writer.close()
```

以下是读取tfRecord文件的代码：

```python
import tensorflow as tf
reader = tf.TFRecordReader()
filename_queue = tf.train.string_input_producer(
    ['./output.tfrecords']
)
_, seriialized_example = reader.read(filename_queue)
features = tf.parse_single_example(serialized_example,
           features = {
             'image_raw':tf.FixedLenFeature([],tf.string),
             'pixels': tf.FixedLenFeature([],tf.int64),
             'label': tf.FixedLenFeature([],tf.int64)
           })
image = tf.decode_raw(features['image_raw'],tf.uint8)
label = tf.cast(features['label'],tf.int32)
pixels = tf.cast(features['pixels'],tf.int32)

sess = tf.Session()
coord = tf.train.Coordinator()
threads = tf.train.start_queue_runners(sess = sess,coord=coord)
for i in range(10):
  print(sess.run(image,label,pixels))
```



## 图像数据处理

