[TOC]

# 图像数据处理

## TFRecord数据格式

当我们需要处理的数据复杂，我们需要有效处理输入数据的信息。tensorflow提供了TFRecord来同意数据的存储。

### TFRecord格式介绍

TFRecord文件的数据是通过`tf.train.Example Protocol buffer`来保存的，下面是`tf.train.Example`的定义：

```python
message Example{
  Features features = 1;
};
message Features{
  map<string,Feature> feature = 1;
};
message Feature{
  oneof kind{
    ByteList bytes_lst = 1;
    FloatList float_list = 2;
    Int64List int64_list = 3;
  };
}
```

Example 是一个数据结构比较简洁的数据，属性取值包含三类，例如图像可以解码成string，类别可以解码成int。下面是使用TFRecord对数据mnist进行保存：

```python
from tensorflow.examples.tutorials.mnist import input_data
import numpy as np

def _int64_features(value):
    return tf.train.Feature(int64_list = tf.train.Int64List(value=[value]))

def _bytes_features(value):
    return tf.train.Feature(bytes_list = tf.train.BytesList(value=[value]))

mnist = input_data.read_data_sets(
    "./data",dtype=tf.uint8,one_hot=True
)
images = mnist.train.images

labels = mnist.train.labels
pixels = images.shape[1]
num_examples = mnist.train.num_examples

filename = './output.tfrecords'

writer = tf.python_io.TFRecordWriter(filename)
for index in range(num_examples):
    image_raw = images[index].tostring()
    example = tf.train.Example(features=tf.train.Features(feature={
        'pixels': _int64_features(pixel),
        'label' : _int64_features(np.argmax(labels[index])),
        'image_raw': _bytes_features(image_raw)
    }))
    writer.write(example.SerializeToString())
writer.close()
```

以下是读取tfRecord文件的代码：

```python
import tensorflow as tf
reader = tf.TFRecordReader()
filename_queue = tf.train.string_input_producer(
    ['./output.tfrecords']
)
_, seriialized_example = reader.read(filename_queue)
features = tf.parse_single_example(serialized_example,
           features = {
             'image_raw':tf.FixedLenFeature([],tf.string),
             'pixels': tf.FixedLenFeature([],tf.int64),
             'label': tf.FixedLenFeature([],tf.int64)
           })
image = tf.decode_raw(features['image_raw'],tf.uint8)
label = tf.cast(features['label'],tf.int32)
pixels = tf.cast(features['pixels'],tf.int32)

sess = tf.Session()
coord = tf.train.Coordinator()
threads = tf.train.start_queue_runners(sess = sess,coord=coord)
for i in range(10):
  print(sess.run(image,label,pixels))
```



## 图像数据处理

tensorflow提供了图像处理函数，在图像增强时对图像进行处理。

### 图像编码处理

tf提供了图像读取以及编码的方法：

```python
import tensorflow as tf

image_raw_data = tf.gFile.FastGFile("./picture",'r').read()

with tf.Session() as sess:
  img_data = tf.image.decode_jpeg(image_raw_data)
# 上述代码将图片转化成三维的数值矩阵

encoded_image = tf.image.encode_jpeg(img_data)
with tf.gFile.GFile('output','wb') as f:
  f.write(encoded_mage.eval())
```

### 图像大小调整

tf提供了四种图像调整的方法，并封装到`tf.image.resize_images` 。

```python
img_data = tf.image.convert_image_dtype(img_data,dtype = tf.float32)

resized = tf.image.resize_images(img_data,[300,300],method = 0)
```

此外tf还提供了API对图像进行裁剪或填充：

```python
croped = tf.image.resize_image_with_crop_or_pad(img_data,1000,1000)
# 不够大就填充，太大就裁剪
```

按比例裁剪：

```python
central_cropped = tf.image.central_crop(img_data,0.5)
```

### 图像翻转

实现图像的上下左右翻转：

```python
# 上下翻转
flipped = tf.image.flip_up_down(img_data)
# 左右翻转
flipped = tf.image.flip_left_right(img_data)
# 对角线翻转
flipped = tf.image.transpose_image(img_data)
# 以一定的概率翻转
flipped = tf.image.random_flip_up_down(img_data)
flipped = tf.image.random_flip_left_right(img_data)
```

### 图像色彩调整

tf提供了许多颜色调整的函数：

```python
adjusted = tf.image.adjust_brightness(img_data,-0.5)
adjusted = tf.clip_by_value(adjusted,0.0,1.0)
# 提升亮度
adjusted = tf.image.adjust_brightness(img_data,0.5)
# 零度随机调整
adjusted = tf.image.random_brightness(image,max_delta)

# 调整对比度
adjusted = tf.image.adjust_contrast(img_data,0.5)

# 调整色相
adjusted = tf.image.adjust_hue(img_data,0.1)

# 饱和度
adjusted = tf.image.adjust_saturation(mg_data,-5)

# 图像标准化
adjusted = tf.image.per_image_standardization(img_data)
```











